# USER_GUIDE (обновлённая версия)

## Содержание
- [1. Обзор системы](#1-обзор-системы)
- [2. Требования](#2-требования)
- [3. Установка и первый запуск](#3-установка-и-первый-запуск)
  - [3.1 Структура проекта](#31-структура-проекта)
  - [3.2 Виртуальное окружение и зависимости](#32-виртуальное-окружение-и-зависимости)
  - [3.3 Конфигурация .env](#33-конфигурация-env)
  - [3.4 Первый запуск](#34-первый-запуск)
  - [3.5 Создание пользователей](#35-создание-пользователей)
- [4. Навигация и адреса модулей](#4-навигация-и-адреса-модулей)
- [5. Модуль «Запчасти»](#5-модуль-запчасти)
  - [5.1 Каталог и поиск](#51-каталог-и-поиск)
  - [5.2 Добавление вручную](#52-добавление-вручную)
  - [5.3 Импорт/Экспорт Excel](#53-импортэкспорт-excel)
  - [5.4 Фото](#54-фото)
- [6. Модуль «Обслуживание» (ТО)](#6-модуль-обслуживание-то)
  - [6.1 Сущности](#61-сущности)
  - [6.2 Оборудование](#62-оборудование)
  - [6.3 Шаблоны чек-листов](#63-шаблоны-чек-листов)
  - [6.4 Планы ТО](#64-планы-то)
  - [6.5 Планировщик → Work Orders](#65-планировщик--work-orders)
  - [6.6 Заполнение Work Order](#66-заполнение-work-order)
  - [6.7 Быстрая форма (QR/ссылка)](#67-быстрая-форма-qrссылка)
- [7. Модуль «Инструментальная оснастка» (Tooling)](#7-модуль-инструментальная-оснастка-tooling)
  - [7.1 Обзор и права](#71-обзор-и-права)
  - [7.2 Подключение модуля (запуск)](#72-подключение-модуля-запуск)
  - [7.3 Инициализация БД для Tooling](#73-инициализация-бд-для-tooling)
  - [7.4 Навигация и адреса Tooling](#74-навигация-и-адреса-tooling)
  - [7.5 Импорт/Экспорт CSV](#75-импортэкспорт-csv)
  - [7.6 Логика ROLE/POSITION, DIM и история](#76-логика-roleposition-dim-и-история)
  - [7.7 Типовые сценарии](#77-типовые-сценарии)
- [8. Полезные утилиты](#8-полезные-утилиты)
- [9. Типичные ошибки и решения](#9-типичные-ошибки-и-решения)
- [10. Рекомендации по кодированию](#10-рекомендации-по-кодированию)
- [11. Продакшен-запуск (кратко)](#11-продакшен-запуск-кратко)
- [12. Планируемые расширения](#12-планируемые-расширения)
- [13. Чек-лист «от нуля до первого WO»](#13-чек-лист-от-нуля-до-первого-wo)

---

## 1. Обзор системы
CRM включает 3 модуля:
- **Запчасти** — каталог, остатки, min/max, импорт/экспорт.
- **Обслуживание** — оборудование, чек-листы, планы ТО, WO, быстрые формы.
- **Tooling (Инструментальная оснастка)** — учёт инструмента, DIM/износ, роли и позиции, полная прослеживаемость, импорт/экспорт.

Роли пользователей:
- `user` — операции в рамках процессов (ставить/снимать инструмент, обслуживание).
- `admin` — как `user`, плюс добавление и импорт/экспорт.
- `root` — полный доступ, редактирование и удаление записей (с сохранением истории).

---

## 2. Требования
- Python 3.10+
- Flask, SQLAlchemy, Flask-Login, Bootstrap 5 (через CDN)
- БД: SQLite или PostgreSQL (рекомендован PG для продакшена)
- (Для PG) драйвер: `psycopg2-binary`

---

## 3. Установка и первый запуск

### 3.1 Структура проекта
```
spare_parts_inventory/
 ├─ app.py
 ├─ config.py
 ├─ extensions.py
 ├─ seed_tooling.py
 ├─ tooling/
 │   ├─ __init__.py
 │   ├─ models_tooling.py
 │   └─ routes_tooling.py
 ├─ templates/
 │   ├─ base.html
 │   ├─ home.html
 │   └─ tooling/
 │       ├─ list_tooling.html
 │       ├─ tooling_detail.html
 │       ├─ tooling_new.html
 │       └─ import_tooling.html
 ├─ migrations/
 │   ├─ 20251021_tooling_full.sql
 │   └─ 20251021_tooling_full_pg.sql (опц., если используете PG)
 └─ static/ ...
```

### 3.2 Виртуальное окружение и зависимости
```bash
python -m venv .venv
# Windows:
. .venv/Scripts/activate
# Linux/Mac:
source .venv/bin/activate

pip install -r requirements.txt
# Для PostgreSQL:
pip install psycopg2-binary
```

### 3.3 Конфигурация .env
```
# SQLite (по умолчанию)
DATABASE_URL=sqlite:///instance/app.db

# или PostgreSQL:
# DATABASE_URL=postgresql+psycopg2://user:password@localhost:5432/spare_parts
FLASK_ENV=development
SECRET_KEY=change_me
```

### 3.4 Первый запуск
В `app.py` зарегистрируйте модули (см. раздел 7.2). Затем:
```bash
python app.py
```
Приложение доступно по http://localhost:5000/

### 3.5 Создание пользователей
Создайте `root`, затем `admin` и `user` (через существующий механизм в проекте: CLI/скрипт/админку).  
Роли: `root`, `admin`, `user`.

---

## 4. Навигация и адреса модулей
- Домашняя: `/` (карточки модулей)
- Запчасти: `/parts/...`
- Обслуживание: `/maintenance/...`
- **Tooling**: `/tooling/...` (оснастка: список, карточка, импорт/экспорт)

---

## 5. Модуль «Запчасти»
### 5.1 Каталог и поиск
Фильтры по SAP/PartNo/названию, быстрый поиск с `Ctrl+K`.

### 5.2 Добавление вручную
Формы в UI, права — с учётом ролей.

### 5.3 Импорт/Экспорт Excel
Импорт/экспорт по готовым шаблонам для массового ввода.

### 5.4 Фото
Загрузка фотографий в карточку.

---

## 6. Модуль «Обслуживание» (ТО)
### 6.1 Сущности
Оборудование, шаблоны чек-листов, Work Orders.

### 6.2 Оборудование
Справочник, атрибуты, привязка к WO и Tooling.

### 6.3 Шаблоны чек-листов
Создание/редактирование, версии.

### 6.4 Планы ТО
Планирование по периодам и счётчикам.

### 6.5 Планировщик → Work Orders
Автогенерация WO, статусы.

### 6.6 Заполнение Work Order
Формы выполнения, вложения, подписи.

### 6.7 Быстрая форма (QR/ссылка)
Полевой ввод без авторизации (по токену/QR).

---

## 7. Модуль «Инструментальная оснастка» (Tooling)

### 7.1 Обзор и права
**Назначение:** учёт инструмента/оснастки с полной прослеживаемостью:
- Статусы: `STOCK`, `INSTALLED`, `NEED_SERVICE`, `IN_SERVICE`, `READY`, `DEFECTIVE`, `SCRAPPED`.
- Сервисные операции: `WASH`, `POLISH`, `INSPECT`, `REPAIR`, `REGRIND`, `MARK_READY`, `MARK_DEFECTIVE`.
- **DIM (диаметр)** и **REGRIND-счётчик**. При `REGRIND` счётчик увеличивается, `current_diameter` можно обновить.
- Привязка к **ROLE** и **POSITION** через слоты. Пример: `IRONING` / `#1`.
- **Авто-снятие**: при установке нового инструмента в занятый слот предыдущий снимается автоматически (история фиксируется).
- Привязка к оборудованию из Maintenance. Вся история содержит дату/время и автора.

**Роли:**
- `user` — ставить/снимать, выполнять операции, менять статусы в рамках процессов.
- `admin` — как `user` + добавление на склад, импорт/экспорт.
- `root` — редактирование/удаление любых записей, SCRAP/soft delete.

### 7.2 Подключение модуля (запуск)
`app.py` (фрагмент):
```python
from flask import Flask
from extensions import db
from tooling.routes_tooling import tooling_bp

def create_app():
    app = Flask(__name__)
    # ... загрузка конфигов, init_app для db, login и т.д.

    # Регистрация блюпринта Tooling
    app.register_blueprint(tooling_bp, url_prefix="/tooling")

    # Чтобы SQLAlchemy создал таблицы на чистой БД
    with app.app_context():
        import tooling.models_tooling
        db.create_all()

    return app
```

В верхнем меню (`base.html`) добавьте кнопку на `/tooling` (если ещё нет).

### 7.3 Инициализация БД для Tooling
**Простой способ (как на запчастях) — seed-скриптом:**
```bash
# создать недостающие таблицы (без удаления данных):
python seed_tooling.py --create

# ПОЛНЫЙ сброс ТОЛЬКО таблиц модуля Tooling и создание заново:
python seed_tooling.py --reset
```
> Скрипт трогает только таблицы Tooling: `tool_types`, `tooling`, `equipment_slots`, `tooling_mounts`, `tooling_events`.  
> Таблицы «Запчастей» и «Обслуживания» не затрагиваются.

**Альтернатива — миграции SQL (однократно):**
- SQLite: выполните `migrations/20251021_tooling_full.sql`
- PostgreSQL: выполните `migrations/20251021_tooling_full_pg.sql`

Перезапустите приложение после инициализации.

### 7.4 Навигация и адреса Tooling
- Список: `/tooling/`
- Добавить на склад: `/tooling/new` (admin/root)
- Импорт: `/tooling/import` (admin/root)
- Экспорт всей базы: `/tooling/export/csv`
- Карточка инструмента: `/tooling/<id>`
  - Установка: `POST /tooling/<id>/install`
  - Снятие: `POST /tooling/<id>/remove`
  - Операции обслуживания: `POST /tooling/<id>/service_op`
  - SCRAP (списание): `POST /tooling/<id>/scrap` (root)
  - Soft Delete: `POST /tooling/<id>/delete` (root)
  - Экспорт истории: `/tooling/<id>/export/history.csv`

### 7.5 Импорт/Экспорт CSV
**Экспорт базы**: `/tooling/export/csv`  
**Экспорт истории**: `/tooling/<id>/export/history.csv`  
**Шаблон импорта**: `/tooling/export/template.csv`

**Импорт** `/tooling/import` — upsert по `tool_code`:
- **Минимум** колонок: `tool_code`, `tool_type_code`
- Рекомендуемые поля:
  ```
  tool_code, tool_type_code, serial_number, intended_role,
  current_diameter, min_diameter, regrind_count,
  current_location, vendor, purchase_date (YYYY-MM-DD), cost,
  status, equipment_name, notes
  ```
- `tool_type_code` — ищется/создаётся автоматически.
- `equipment_name` — если находится в Maintenance — привяжется.
- Числа можно с точкой или запятой.
- Новые записи получают событие `CREATE` в историю.

### 7.6 Логика ROLE/POSITION, DIM и история
- При **установке** обязательны: `ROLE`, `POSITION` и `REASON`.
- Если слот занят — предыдущий инструмент **автоматически снимается**, ему ставится статус `NEED_SERVICE`, mount закрывается, событие пишется в историю.
- Контроль износа: если `current_diameter < min_diameter`, установка блокируется.
- Каждое действие создаёт событие с таймштампом, пользователем, `from_status → to_status`, `equipment/slot`, `SHIFT`, `DIM → NEW DIM`, `REASON`, `NOTE`.

### 7.7 Типовые сценарии
- **Установка на машину**: карточка → выбрать Equipment, ROLE/POSITION, указать REASON → Install.  
  Проверить авто-снятие, если слот был занят.
- **Снятие**: карточка → Remove → статус `NEED_SERVICE`, mount закрыт.
- **Перешлифовка (REGRIND)**: Service operation = REGRIND → указать `dimension` (до) и `new_dimension` (после), `reason`, `shift` (опц.).  
  Статус: `IN_SERVICE`, +1 к `regrind_count`, обновляется `current_diameter`.
- **Готов к установке**: `MARK_READY` → статус `READY`.
- **Дефект**: `MARK_DEFECTIVE` → статус `DEFECTIVE`.
- **Списание**: `SCRAP` (root), история сохраняется.

---

## 8. Полезные утилиты
- `seed_tooling.py` — инициализация/сброс таблиц Tooling.
- Импорт/экспорт CSV — быстрый массовый ввод/выгрузка.

---

## 9. Типичные ошибки и решения
- **`sqlite3.OperationalError: no such column: tooling.intended_role`**  
  Причина: таблица не обновлена до текущей версии моделей.  
  Решение: выполнить инициализацию/миграцию (см. 7.3), перезапустить сервер.

- **Подключилось к SQLite вместо PostgreSQL**  
  Проверь `DATABASE_URL` в окружении/конфиге. Установи `psycopg2-binary`, укажи строку PG и заново прогоните инициализацию.

---

## 10. Рекомендации по кодированию
- Соблюдать RBAC: `user`/`admin`/`root`.
- В истории всегда заполнять `REASON` и, по возможности, `SHIFT`.
- Для DIM указывать `dimension` (до) и `new_dimension` (после) при операциях обслуживания.
- Не удалять «жёстко»: использовать SCRAP/soft delete — история важнее.

---

## 11. Продакшен-запуск (кратко)
- PostgreSQL, `gunicorn`/`uvicorn` + reverse proxy (nginx).
- Переменные окружения: `DATABASE_URL`, `SECRET_KEY`, и пр.
- Регулярные бэкапы БД.
- Логи приложения и ошибок в отдельные файлы.

---

## 12. Планируемые расширения
- Импорт/экспорт в XLSX.
- Предупреждения о приближении к `min_diameter`.
- Отчёты по износу и трендам DIM.
- Групповые операции (bulk actions).

---

## 13. Чек-лист «от нуля до первого WO»
1. Настроить `.env` → `DATABASE_URL`, `SECRET_KEY`.  
2. Установить зависимости, запустить приложение.  
3. Создать пользователей `root`, `admin`, `user`.  
4. Завести оборудование в Maintenance.  
5. **Tooling → инициализация БД**: `python seed_tooling.py --create` (или `--reset`).  
6. Добавить типы и 1–2 инструмента на склад **вручную** либо **импортом CSV**.  
7. Открыть карточку инструмента → **Install**: выбрать Equipment, ROLE/POSITION, REASON.  
8. Проверить авто-снятие в слоте при установке другого инструмента.  
9. Выполнить `REGRIND` с фиксацией DIM → убедиться, что история пишется и `regrind_count` увеличивается.  
10. Воспользоваться экспортом истории инструмента в CSV.  
11. Создать план ТО и сгенерировать WO; связать фактические работы с Tooling при необходимости.  
12. Готово!
